use cleandb;
-----------------------------------------------------
INSERT INTO `Provincia` (`IdProvincia`, `Detalle`) VALUES (1, 'BUENOS AIRES');
INSERT INTO `Provincia` (`IdProvincia`, `Detalle`) VALUES (2, 'CAPITAL FEDERAL');
INSERT INTO `Provincia` (`IdProvincia`, `Detalle`) VALUES (3, 'CATAMARCA');
INSERT INTO `Provincia` (`IdProvincia`, `Detalle`) VALUES (4, 'CHACO');
INSERT INTO `Provincia` (`IdProvincia`, `Detalle`) VALUES (5, 'CHUBUT');
INSERT INTO `Provincia` (`IdProvincia`, `Detalle`) VALUES (6, 'CORDOBA');
INSERT INTO `Provincia` (`IdProvincia`, `Detalle`) VALUES (7, 'CORRIENTES');
INSERT INTO `Provincia` (`IdProvincia`, `Detalle`) VALUES (8, 'ENTRE RIOS');
INSERT INTO `Provincia` (`IdProvincia`, `Detalle`) VALUES (9, 'FORMOSA');
INSERT INTO `Provincia` (`IdProvincia`, `Detalle`) VALUES (10, 'JUJUY');
INSERT INTO `Provincia` (`IdProvincia`, `Detalle`) VALUES (11, 'LA PAMPA');
INSERT INTO `Provincia` (`IdProvincia`, `Detalle`) VALUES (12, 'LA RIOJA');
INSERT INTO `Provincia` (`IdProvincia`, `Detalle`) VALUES (13, 'MENDOZA');
INSERT INTO `Provincia` (`IdProvincia`, `Detalle`) VALUES (14, 'MISIONES');
INSERT INTO `Provincia` (`IdProvincia`, `Detalle`) VALUES (15, 'NEUQUEN');
INSERT INTO `Provincia` (`IdProvincia`, `Detalle`) VALUES (16, 'RIO NEGRO');
INSERT INTO `Provincia` (`IdProvincia`, `Detalle`) VALUES (17, 'SALTA');
INSERT INTO `Provincia` (`IdProvincia`, `Detalle`) VALUES (18, 'SAN JUAN');
INSERT INTO `Provincia` (`IdProvincia`, `Detalle`) VALUES (19, 'SAN LUIS');
INSERT INTO `Provincia` (`IdProvincia`, `Detalle`) VALUES (20, 'SANTA CRUZ');
INSERT INTO `Provincia` (`IdProvincia`, `Detalle`) VALUES (21, 'SANTA FE');
INSERT INTO `Provincia` (`IdProvincia`, `Detalle`) VALUES (22, 'SANTIAGO DEL ESTERO');
INSERT INTO `Provincia` (`IdProvincia`, `Detalle`) VALUES (23, 'TIERRA DEL FUEGO');
INSERT INTO `Provincia` (`IdProvincia`, `Detalle`) VALUES (24, 'TUCUMAN');
-----------------------------------------------------
-- Inserts para la provincia de Buenos Aires
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (1, 'La Plata');
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (1, 'Mar del Plata');
-- Inserts para la provincia de Capital Federal
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (2, 'Buenos Aires');
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (2, 'Palermo');
-- Inserts para la provincia de Catamarca
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (3, 'San Fernando del Valle de Catamarca');
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (3, 'Valle Viejo');
-- Inserts para la provincia de Chaco
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (4, 'Resistencia');
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (4, 'Barranqueras');
-- Inserts para la provincia de Chubut
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (5, 'Comodoro Rivadavia');
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (5, 'Trelew');
-- Inserts para la provincia de Córdoba
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (6, 'Córdoba');
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (6, 'Villa Carlos Paz');
-- Inserts para la provincia de Corrientes
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (7, 'Corrientes');
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (7, 'Goya');
-- Inserts para la provincia de Entre Ríos
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (8, 'Paraná');
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (8, 'Concordia');
-- Inserts para la provincia de Formosa
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (9, 'Formosa');
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (9, 'Clorinda');
-- Inserts para la provincia de Jujuy
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (10, 'San Salvador de Jujuy');
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (10, 'Palpalá');
-- Inserts para la provincia de La Pampa
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (11, 'Santa Rosa');
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (11, 'General Pico');
-- Inserts para la provincia de La Rioja
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (12, 'La Rioja');
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (12, 'Chilecito');
-- Inserts para la provincia de Mendoza
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (13, 'Mendoza');
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (13, 'San Rafael');
-- Inserts para la provincia de Misiones
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (14, 'Posadas');
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (14, 'Puerto Iguazú');
-- Inserts para la provincia de Neuquén
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (15, 'Neuquén');
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (15, 'Cutral Có');
-- Inserts para la provincia de Río Negro
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (16, 'Viedma');
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (16, 'Bariloche');
-- Inserts para la provincia de Salta
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (17, 'Salta');
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (17, 'San Ramón de la Nueva Orán');
-- Inserts para la provincia de San Juan
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (18, 'San Juan');
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (18, 'Rivadavia');
-- Inserts para la provincia de San Luis
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (19, 'San Luis');
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (19, 'Villa Mercedes');
-- Inserts para la provincia de Santa Cruz
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (20, 'Río Gallegos');
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (20, 'Caleta Olivia');
-- Inserts para la provincia de Santa Fe
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (21, 'Santa Fe');
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (21, 'Rosario');
-- Inserts para la provincia de Santiago del Estero
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (22, 'Santiago del Estero');
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (22, 'La Banda');
-- Inserts para la provincia de Tierra del Fuego
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (23, 'Ushuaia');
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (23, 'Río Grande');
-- Inserts para la provincia de Tucumán
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (24, 'San Miguel de Tucumán');
INSERT INTO Localidad (IdProvincia, Detalle) VALUES (24, 'Yerba Buena');
-----------------------------------------------------
INSERT INTO `cleandb`.`tipopersonasistema`(`Descripcion`)
VALUES("Empleado");
INSERT INTO `cleandb`.`tipopersonasistema`(`Descripcion`)
VALUES("Proveedores");
INSERT INTO `cleandb`.`tipopersonasistema`(`Descripcion`)
VALUES("Clientes");
-----------------------------------------------------
INSERT INTO `cleandb`.`tipodocumentacion`(`Descripcion`)
VALUES("DNI");
INSERT INTO `cleandb`.`tipodocumentacion`(`Descripcion`)
VALUES("CUIL");
INSERT INTO `cleandb`.`tipodocumentacion`(`Descripcion`)
VALUES("CUIT");
INSERT INTO `cleandb`.`tipodocumentacion`(`Descripcion`)
VALUES("PASAPORTE");
-----------------------------------------------------
INSERT INTO `cleandb`.`tipopersona`(`Descripcion`)
VALUES("Jurídica");
INSERT INTO `cleandb`.`tipopersona`(`Descripcion`)
VALUES("Física");
-----------------------------------------------------
INSERT INTO `cleandb`.`tipodomicilio`(`Descripcion`)
VALUES("Legal");
INSERT INTO `cleandb`.`tipodomicilio`(`Descripcion`)
VALUES("Real");
INSERT INTO `cleandb`.`tipodomicilio`(`Descripcion`)
VALUES("Juridico");
INSERT INTO `cleandb`.`tipodomicilio`(`Descripcion`)
VALUES("Fiscal");
--------------------------------------------- Inserto en TipoRol ---------------------------------------------
INSERT INTO `cleandb`.`tiporol`(`Descripcion`)
VALUES("Dueño");
INSERT INTO `cleandb`.`tiporol`(`Descripcion`)
VALUES("Empleado");
INSERT INTO `cleandb`.`tiporol`(`Descripcion`)
VALUES("Repartidor");
--------------------------------------------- Inserto en TipoPermiso ---------------------------------------------
INSERT INTO `cleandb`.`tipopermiso`(`Detalle`)
VALUES("Nivel 1");
INSERT INTO `cleandb`.`tipopermiso`(`Detalle`)
VALUES("Nivel 2");
INSERT INTO `cleandb`.`tipopermiso`(`Detalle`)
VALUES("Nivel 3");
INSERT INTO `cleandb`.`tipopermiso`(`Detalle`)
VALUES("Nivel 4");
--------------------------------------------- Inserto en TipoPermisoDetalle ---------------------------------------------
INSERT INTO `cleandb`.`tipopermisodetalle`(`IdTipoPermiso`,`Method`)
VALUES(1, "GET");
INSERT INTO `cleandb`.`tipopermisodetalle`(`IdTipoPermiso`,`Method`)
VALUES(1, "PUT");
INSERT INTO `cleandb`.`tipopermisodetalle`(`IdTipoPermiso`,`Method`)
VALUES(1, "DELETE");
INSERT INTO `cleandb`.`tipopermisodetalle`(`IdTipoPermiso`,`Method`)
VALUES(1, "POST");

INSERT INTO `cleandb`.`tipopermisodetalle`(`IdTipoPermiso`,`Method`)
VALUES(2, "GET");
INSERT INTO `cleandb`.`tipopermisodetalle`(`IdTipoPermiso`,`Method`)
VALUES(2, "PUT");
INSERT INTO `cleandb`.`tipopermisodetalle`(`IdTipoPermiso`,`Method`)
VALUES(2, "POST");

INSERT INTO `cleandb`.`tipopermisodetalle`(`IdTipoPermiso`,`Method`)
VALUES(3, "GET");
INSERT INTO `cleandb`.`tipopermisodetalle`(`IdTipoPermiso`,`Method`)
VALUES(3, "POST");

INSERT INTO `cleandb`.`tipopermisodetalle`(`IdTipoPermiso`,`Method`)
VALUES(4, "GET");
-----------------------------------------------------
INSERT INTO `cleandb`.`domicilio`(`IdTipoDomicilio`,`Calle`,`Nro`,`Piso`)
VALUES(1, "Corrientes y Cuañeti", "431", "0");
-----------------------------------------------------
INSERT INTO `cleandb`.`persona`(`IdTipoPersonaSistema`,`IdTipoPersona`,`IdDomicilio`,`IdLocalidad`,`IdTipoDocumentacion`,`Documentacion`,`Nombre`,`Apellido`,
`Mail`,`RazonSocial`,`FechaNacimiento`,`Telefono`,`FechaAlta`)
VALUES(1, 1, 1, 3, 1,"44343826", "Lautaro", "Britez", "lautibritez@gmail.com", "LAUTI BRITEZ", "1990-01-01", "123456789", now());
INSERT INTO `cleandb`.`usuario`(`IdPersona`,`Usuario`,`Clave`,`IdUsuarioCarga`,`FechaAlta`)
VALUES(1, 'lautaro', SHA2('123', 256), 1, NOW());
------------------- INSERTS SISTEMAPIS ---------------------------------------------
INSERT INTO `cleandb`.`sistemaapis` (`Detalle`,`Method`,`Path`,`IdUsuarioCarga`,`FechaAlta`,`FechaBaja`)
VALUES("Login", "POST", "auth", 1, now(), NULL);

INSERT INTO `cleandb`.`sistemaapis` (`Detalle`,`Method`,`Path`,`IdUsuarioCarga`,`FechaAlta`,`FechaBaja`)
VALUES("Obtener Menu", "GET", "utils/menu", 1, now(), NULL);

INSERT INTO `cleandb`.`sistemaapis` (`Detalle`,`Method`,`Path`,`IdUsuarioCarga`,`FechaAlta`,`FechaBaja`)
VALUES("Obtener SubMenu", "GET", "utils/menu/**/submenu", 1, now(), NULL);

INSERT INTO `cleandb`.`sistemaapis` (`Detalle`,`Method`,`Path`,`IdUsuarioCarga`,`FechaAlta`,`FechaBaja`)
VALUES("Obtener Icono SubMenu", "GET", "utils/submenu/image", 1, now(), NULL);

--------------------------------------------- INSERTS TIPOMODULO ---------------------------------------------
---------- Revisar tannto el tipomenu, en donde 1 debe ser el que van a entrar por defecto, como el orden, si hacemos por numero de insersion o no ----------

INSERT INTO `cleandb`.`tipomodulo`(`IdPadre`,`Orden`,`Detalle`,`PathRout`,`TipoMenu`,`TipoIcono`,`Icono`,`FechaAlta`,`FechaBaja`)
VALUES(0, "01", "Home", "/home", 1, "data:image/jpeg;base64,", "", now(), null);

INSERT INTO `cleandb`.`tipomodulo`(`IdPadre`,`Orden`,`Detalle`,`PathRout`,`TipoMenu`,`TipoIcono`,`Icono`,`FechaAlta`,`FechaBaja`)
VALUES(0, "02", "Seguridad", "/seguridad", 2, "data:image/jpeg;base64,", "", now(), null);

INSERT INTO `cleandb`.`tipomodulo`(`IdPadre`,`Orden`,`Detalle`,`PathRout`,`TipoMenu`,`TipoIcono`,`Icono`,`FechaAlta`,`FechaBaja`)
VALUES(0, "03", "Parametria", "/parametria", 2, "data:image/jpeg;base64,", "", now(), null);

INSERT INTO `cleandb`.`tipomodulo`(`IdPadre`,`Orden`,`Detalle`,`PathRout`,`TipoMenu`,`TipoIcono`,`Icono`,`FechaAlta`,`FechaBaja`)
VALUES(0, "04", "Recursos", "/recursos", 2, "data:image/jpeg;base64,", "", now(), null);

INSERT INTO `cleandb`.`tipomodulo`(`IdPadre`,`Orden`,`Detalle`,`PathRout`,`TipoMenu`,`TipoIcono`,`Icono`,`FechaAlta`,`FechaBaja`)
VALUES(0, "05", "Reportes", "/reportes", 2, "data:image/jpeg;base64,", "", now(), null);

INSERT INTO `cleandb`.`tipomodulo`(`IdPadre`,`Orden`,`Detalle`,`PathRout`,`TipoMenu`,`TipoIcono`,`Icono`,`FechaAlta`,`FechaBaja`)
VALUES(0, "06", "Gestión", "/gestion", 2, "data:image/jpeg;base64,", "", now(), null);

INSERT INTO `cleandb`.`tipomodulo`(`IdPadre`,`Orden`,`Detalle`,`PathRout`,`TipoMenu`,`TipoIcono`,`Icono`,`FechaAlta`,`FechaBaja`)
VALUES(2, "02.01", "Usuarios", "/seguridad/usuarios", 3, "data:image/jpeg;base64,", "", now(), null);
INSERT INTO `cleandb`.`tipomodulo`(`IdPadre`,`Orden`,`Detalle`,`PathRout`,`TipoMenu`,`TipoIcono`,`Icono`,`FechaAlta`,`FechaBaja`)
VALUES(2, "02.02", "Tipo Roles", "/seguridad/tiporoles", 3, "data:image/jpeg;base64,", "", now(), null);
INSERT INTO `cleandb`.`tipomodulo`(`IdPadre`,`Orden`,`Detalle`,`PathRout`,`TipoMenu`,`TipoIcono`,`Icono`,`FechaAlta`,`FechaBaja`)
VALUES(2, "02.03", "Módulos por Rol", "/seguridad/rolmodulos", 3, "data:image/jpeg;base64,", "", now(), null);
INSERT INTO `cleandb`.`tipomodulo`(`IdPadre`,`Orden`,`Detalle`,`PathRout`,`TipoMenu`,`TipoIcono`,`Icono`,`FechaAlta`,`FechaBaja`)
VALUES(2, "02.04", "APIs por Módulo", "/seguridad/apispormodulo", 3, "data:image/jpeg;base64,", "", now(), null);
-------------------------------------------- Inserto en SistemaModuloApis ---------------------------------------------
INSERT INTO `cleandb`.`sistemamoduloapis`(`IdTipoModulo`,`IdSistemasAPIs`,`IdUsuarioCarga`,`FechaAlta`,`FechaBaja`)
VALUES(1, 4, 1, now(), null);
--------------------------------------------- Inserto en RolModulo ---------------------------------------------
INSERT INTO `cleandb`.`rolmodulo`(`IdTipoRol`,`IdTipoModulo`,`IdTipoPermiso`)
VALUES(1, 1, 1);
INSERT INTO `cleandb`.`rolmodulo`(`IdTipoRol`,`IdTipoModulo`,`IdTipoPermiso`)
VALUES(1, 2, 1);
INSERT INTO `cleandb`.`rolmodulo`(`IdTipoRol`,`IdTipoModulo`,`IdTipoPermiso`)
VALUES(1, 7, 1);
INSERT INTO `cleandb`.`rolmodulo`(`IdTipoRol`,`IdTipoModulo`,`IdTipoPermiso`)
VALUES(1, 8, 1);
INSERT INTO `cleandb`.`rolmodulo`(`IdTipoRol`,`IdTipoModulo`,`IdTipoPermiso`)
VALUES(1, 9, 1);
INSERT INTO `cleandb`.`rolmodulo`(`IdTipoRol`,`IdTipoModulo`,`IdTipoPermiso`)
VALUES(1, 10, 1);
--------------------- Inserto un token y un rol para el usuario --------------------------------
INSERT INTO `cleandb`.`usuariotoken`(`IdPersona`,`IdUsuario`,`Token`,`FechaAlta`,`FechaCaducidad`,`Activo`)
VALUES(1, 1, "ceci", now(), 10, 1);
INSERT INTO `cleandb`.`usuariorol`(`IdUsuario`,`IdTipoRol`,`IdUsuarioCarga`,`FechaCarga`)
VALUES(1, 1, 1, now());
-----------------------------------------------------
DROP PROCEDURE IF EXISTS SP_ValidarUsuario;
-- Procedimiento Almacenado que Valida que el usuario este registrado en nuestro sistema--
DELIMITER //
CREATE PROCEDURE `SP_ValidarUsuario` (IN p_usuario VARCHAR(45), IN p_clave VARCHAR(255), OUT p_resultado BOOLEAN)
BEGIN
    DECLARE v_count INT;
	DECLARE v_hashed_clave VARCHAR(255);
    -- Deshashear la contraseña proporcionada
    SET v_hashed_clave = SHA2(p_clave, 256);

    -- Verificar si el usuario y la contraseña coinciden en la tabla Usuario
    SELECT COUNT(*) INTO v_count
    FROM Usuario u
    JOIN Persona p ON u.IdPersona = p.IdPersona
    WHERE u.Usuario = p_usuario AND u.Clave = v_hashed_clave;

    -- Si el conteo es mayor que 0, significa que las credenciales son válidas
    IF v_count > 0 THEN
        SET p_resultado = TRUE;
    ELSE
        SET p_resultado = FALSE;
    END IF;
END //
DELIMITER ;
--------------------------------------------- CREO EL SP DE GETMENU ---------------------------------------------
-- Para llamar al getmenu, debo pasarle el bearer de la persona que esta logueada que tendra su credencial con el rol que le corresponde y podremos obtener los menus a mostrar --
-- CALL SP_GetMenu('ceci');  --
DELIMITER //
CREATE PROCEDURE SP_GetMenu (
    IN p_bearer TEXT
)
BEGIN
    DECLARE v_Id INT;
    SET SQL_SAFE_UPDATES = 0;

    CREATE TEMPORARY TABLE Menues (
        IdTipoModulo INT,
        Orden VARCHAR(10),
        Detalle VARCHAR(100),
        PathRoute VARCHAR(100),
        TipoMenu INT,
        TipoIcono VARCHAR(100),
        Icono TEXT,
        PoseePermiso INT
    );

    INSERT INTO Menues(IdTipoModulo, Orden, Detalle, PathRoute, TipoMenu, TipoIcono, Icono)
    SELECT IdTipoModulo, Orden, Detalle, PathRout, TipoMenu, TipoIcono, Icono
    FROM cleandb.TipoModulo
    WHERE FechaBaja IS NULL AND IdPadre = 0;

    UPDATE Menues
    SET PathRoute = CONCAT('/', CAST(IdTipoModulo AS CHAR(10)), '/submenu')
    WHERE TipoMenu = 2;

	UPDATE Menues
	SET PoseePermiso = 1
	WHERE IdTipoModulo IN (
		SELECT D.IdTipoModulo
		FROM Persona AS E
		INNER JOIN Usuario AS F ON E.IdPersona = F.IdPersona
		INNER JOIN UsuarioToken AS T ON T.IdPersona = E.IdPersona
		INNER JOIN UsuarioRol AS UR ON UR.IdUsuario = F.IdUsuario
		INNER JOIN TipoRol AS TR ON TR.IdTipoRol = UR.IdTipoRol
		INNER JOIN RolModulo AS C ON C.IdTipoRol = TR.IdTipoRol
		INNER JOIN TipoModulo AS D ON D.IdTipoModulo = C.IdTipoModulo
		WHERE T.Token = p_bearer
		AND D.FechaBaja IS NULL
		AND D.PathRout IS NOT NULL
	);
    
    UPDATE Menues 
    SET PoseePermiso = 0
    WHERE PoseePermiso IS NULL;

    SELECT * FROM Menues;
	DROP TABLE IF EXISTS Menues;
END //
DELIMITER //
--------------------------------------------- CREO EL SP DE GETSUBMENU ---------------------------------------------
-- Para llamar al SUBGETMENU, debo pasarle el bearer de la persona que esta logueada y el id del menu (IDPADRE en TipoModulo) a donde esta queriendo entrar --
-- CALL SP_GetSubMenu('ceci', 2);  --
DELIMITER //
CREATE PROCEDURE SP_GetSubMenu (
    IN p_bearer TEXT,
    IN p_IdMenu INT
)
BEGIN
    DECLARE v_Id INT;

    CREATE TEMPORARY TABLE Menues (
        Id INT,
        Orden VARCHAR(10),
        Detalle VARCHAR(100),
        PathRoute VARCHAR(100),
        TipoIcono VARCHAR(100),
        Icono TEXT,
        PoseePermiso INT
    );

    INSERT INTO Menues(Id, Orden, Detalle, PathRoute, TipoIcono, Icono)
    SELECT IdTipoModulo, Orden, Detalle, PathRout, TipoIcono, Icono
    FROM cleandb.TipoModulo
    WHERE FechaBaja IS NULL AND IdPadre = p_IdMenu;

    UPDATE Menues
    SET PoseePermiso = 1
    WHERE Id IN (
        SELECT D.IdTipoModulo
        FROM Persona AS E
        INNER JOIN Usuario AS F ON E.IdPersona = F.IdPersona
        INNER JOIN UsuarioToken AS T ON T.IdPersona = E.IdPersona
        INNER JOIN UsuarioRol AS UR ON UR.IdUsuario = F.IdUsuario
        INNER JOIN TipoRol AS TR ON TR.IdTipoRol = UR.IdTipoRol
        INNER JOIN RolModulo AS C ON C.IdTipoRol = TR.IdTipoRol
        INNER JOIN TipoModulo AS D ON D.IdTipoModulo = C.IdTipoModulo
        WHERE T.Token = p_bearer
        AND D.FechaBaja IS NULL
        AND D.PathRout IS NOT NULL
    );

    UPDATE Menues 
    SET PoseePermiso = 0
    WHERE PoseePermiso IS NULL;

    SELECT * FROM Menues;
    DROP TEMPORARY TABLE IF EXISTS Menues;
END //
--------------------------------------------- CREO EL SP DE GetImagenSubMenu ---------------------------------------------
-- Hay que pasarle la PATH como parametro para que arroje el icono del modulo solicitado --
-- CALL SP_GetImagenSubMenu('/seguridad/usuarios');  --
DELIMITER //
CREATE PROCEDURE SP_GetImagenSubMenu (
    IN p_RoutePath VARCHAR(100)
)
BEGIN
    SELECT 
        IdTipoModulo,
        TipoIcono,
        Icono
    FROM cleandb.TipoModulo
    WHERE PathRout = p_RoutePath;
END //
DELIMITER //
--------------------------------------------- CREO EL SP DE GETMENUSUARIO ---------------------------------------------
-- Para llamar al GETMENUSUARIO, debo pasarle el ID DEL USUARIO LOGUEADO, y este devuelve el rol, nivel, el menu y la ruta habilitada del usuario --
-- CALL SP_GetMenuUsuario(1);  --
DELIMITER //
CREATE PROCEDURE SP_GetMenuUsuario (
    IN p_IdPersona INT
)
BEGIN
    SELECT 
        B.Descripcion AS Rol,
        C.IdTipoPermiso AS Nivel,
        D.Detalle AS MenuDescripcion,
        D.PathRout AS MenuRutaHabilitada 
    FROM Persona AS E 
    INNER JOIN Usuario AS F ON E.IdPersona = F.IdPersona
    INNER JOIN UsuarioRol AS A ON E.IdPersona = A.IdUsuario
    INNER JOIN TipoRol AS B ON A.IdTipoRol = B.IdTipoRol
    INNER JOIN RolModulo AS C ON B.IdTipoRol = C.IdTipoRol
    INNER JOIN TipoModulo AS D ON C.IdTipoModulo = D.IdTipoModulo
    WHERE E.IdPersona = p_IdPersona
    AND D.PathRout IS NOT NULL;
END //
DELIMITER //
--------------------------------------------- CREO EL SP DE SISTEMAAPIS ---------------------------------------------
-- Para llamar al metodo debo pasarle el METODO, o sea get put delete o post, mas el nombre de la api --
-- CALL SP_SistemaAPIs('GET', 'Obtener Menu'); --
DELIMITER //
CREATE PROCEDURE SP_SistemaAPIs (
    IN Metodo VARCHAR(100),
    IN Nombre VARCHAR(100)
)
BEGIN
    SELECT IdSistemaAPIs, Detalle, Method, Path
    FROM cleandb.SistemaAPIs
    WHERE (Method = COALESCE(Metodo, Method)) 
    AND (Detalle LIKE CONCAT('%', COALESCE(Nombre, Detalle), '%'));
END //
DELIMITER //
--------------------------------------------- CREO EL SP DE SistemaModuloApis ---------------------------------------------
-- Para llamar al metodo debo pasarle el id del tipomodulo, la paginacion, la cantidad de registros y el tipo de lista --
-- CALL SP_SistemaModuloApis(1, 5, 999, 1); --
DELIMITER //
CREATE PROCEDURE SP_SistemaModuloApis (
    IN p_IdTipoModulo INT,
    IN p_Pagina INT,
    IN p_CantRegistros INT,
    IN p_TipoLista TINYINT
)
BEGIN
    DECLARE SkipRegistros INT;
    
    SET SkipRegistros = (p_Pagina - 1) * p_CantRegistros;

    IF p_TipoLista IN (1, 2, 3) THEN
        SELECT 
            a.IdSistemaModuloAPIs AS Id,
            a.IdTipoModulo,
            b.Detalle AS Modulo,
            a.IdSistemasAPIs AS IdSistemaAPIs,
            c.Detalle AS SistemaAPIs,
            c.Method AS Metodo,
            c.Path AS Ruta,
            (SELECT COUNT(*) FROM SistemaModuloApis WHERE IdTipoModulo = p_IdTipoModulo) AS CantRegistros
        FROM
            SistemaModuloApis a
        INNER JOIN
            TipoModulo b ON a.IdTipoModulo = b.IdTipoModulo
        INNER JOIN
            SistemaAPIs c ON a.IdSistemasAPIs = c.IdSistemaAPIs
        WHERE
            a.IdTipoModulo = COALESCE(p_IdTipoModulo, a.IdTipoModulo)
        ORDER BY
            a.IdSistemaModuloAPIs
        LIMIT SkipRegistros, p_CantRegistros;
    END IF;
END //
DELIMITER ;
--------------------------------------------- CREO EL SPA DE UsuarioToken ---------------------------------------------
-- Para llamar al metodo debo pasarle el id de la persona y el token --
-- CALL SPA_UsuarioToken(1, 'ceci'); --
DELIMITER //
CREATE PROCEDURE `SPA_UsuarioToken`(
    IN IdPersonalIN INT,
    IN Token TEXT
)
BEGIN
    DECLARE Message VARCHAR(50);
    DECLARE NombrePersonal VARCHAR(100);
    DECLARE DocumentacionPersonal INT;
    DECLARE UsuarioId INT;
    DECLARE TiempoToken INT;

    SELECT IdUsuario INTO UsuarioId
	FROM Usuario
	WHERE IdPersona = IdPersonalIN AND FechaBaja IS NULL AND IdPersona IS NOT NULL;

    IF UsuarioId IS NOT NULL THEN
		SET TiempoToken = 60;
        SET Message = 'Ok';
        UPDATE UsuarioToken
		SET Activo = 0
		WHERE IdPersona = IdPersonalIN;
		
		INSERT INTO UsuarioToken(IdPersona, IdUsuario, Token, FechaAlta, FechaCaducidad, Activo)
		VALUES(IdPersonalIN, UsuarioId, Token, NOW(), DATE_ADD(NOW(), INTERVAL TiempoToken MINUTE), 1);
		
		SELECT Nombre, Documentacion INTO NombrePersonal, DocumentacionPersonal
		FROM Persona
		WHERE IdPersona = IdPersonalIN;
    ELSE
        SET Message = 'Personal Inexistente';
    END IF;
    
    SELECT Message AS Mensaje, 
           TiempoToken AS TiempoCaduca,
           NombrePersonal AS NombrePersonal,
           DocumentacionPersonal AS DocumentacionPersonal;
END//
DELIMITER ;
--------------------------------------------- CREO EL FN DE ObtenerUsuDesdeBearer ---------------------------------------------
-- Para llamar al metodo debo pasarle el token de la persona y lde devolvera 1 si existe y NULL si no existe --
-- SELECT FN_ObtenerUsuDesdeBearer('ceci');
DELIMITER //
CREATE FUNCTION `FN_ObtenerUsuDesdeBearer`(
    p_UsuarioBearer text(500)
)
RETURNS INT
DETERMINISTIC
READS SQL DATA
BEGIN
    DECLARE v_IdUsu INT;
    SELECT IdUsuario INTO v_IdUsu
    FROM UsuarioToken
    WHERE Token = p_UsuarioBearer AND Activo = 1; 
    RETURN v_IdUsu;
END//
--------------------------------------------- CREO EL SPA DE TipoRol ---------------------------------------------
-- Para llamar al metodo debo pasarle la descripcion que estoy queriendo agregar y el token --
-- CALL SPA_TipoRol('AA', 'ceci'); --
DELIMITER //
CREATE PROCEDURE `SPA_TipoRol`(
    IN p_Descripcion VARCHAR(50), 
    IN p_UsuarioBearer TEXT
)
BEGIN
    DECLARE v_IdUsuarioCarga INT;
    DECLARE v_Message VARCHAR(50);
    SET v_IdUsuarioCarga = FN_ObtenerUsuDesdeBearer(p_UsuarioBearer);
	IF v_IdUsuarioCarga IS NOT NULL THEN
		IF (SELECT COUNT(*) FROM TipoRol WHERE Descripcion = p_Descripcion) = 0 THEN
			INSERT INTO TipoRol (Descripcion, FechaBaja)
			VALUES (p_Descripcion, NULL);
			SET v_Message = 'OK';
		ELSE 
			SET v_Message = 'El valor ingresado ya existe';
		END IF;
	ElSE
		SET v_Message = 'Token Inválido';
	END IF;
	-- Devolver el mensaje
	SELECT v_Message;
		
END//
DELIMITER ;
--------------------------------------------- CREO EL SPM DE TipoRol ---------------------------------------------
-- Para llamar al metodo debo pasarle el id del tiporol que estoy queriendo modificar, el valor nuevo y el token  --
-- CALL SPM_TipoRol(3, 'Repartidor', 'ceci'); --
DELIMITER //
CREATE PROCEDURE `SPM_TipoRol`(
	IN p_Id INT, 
    IN p_Descripcion VARCHAR(50), 
    IN p_UsuarioBearer text(500)
)
BEGIN
    DECLARE v_IdUsuarioCarga INT;
    DECLARE v_Message VARCHAR(50);
    DECLARE v_CountExistTipoRol INT;
    
    SET v_IdUsuarioCarga = FN_ObtenerUsuDesdeBearer(p_UsuarioBearer);
    SELECT COUNT(*) INTO v_CountExistTipoRol FROM TipoRol WHERE IdTipoRol = p_Id;
    
	IF v_IdUsuarioCarga IS NOT NULL THEN
		IF v_CountExistTipoRol = 0 THEN
			SET v_Message = 'El TipoRol ingresado no existe.';
		ELSE
			IF (SELECT COUNT(*) FROM TipoRol WHERE IdTipoRol = p_Id AND Descripcion = p_Descripcion) = 0 THEN
				IF (SELECT COUNT(*) FROM TipoRol WHERE IdTipoRol = p_Id AND FechaBaja IS NOT NULL) = 0 THEN
					UPDATE TipoRol 
					SET Descripcion = p_Descripcion, FechaBaja = NULL 
					WHERE IdTipoRol = p_Id;
					SET v_Message = 'OK';
				ELSE 
					SET v_Message = 'El valor ingresado se encuentra inhabilitado.';
				END IF;
			ELSE 
				SET v_Message = 'El valor ingresado ya existe.';
			END IF;
		END IF;
	ElSE
		SET v_Message = 'Token Inválido.';
	END IF;
    SELECT v_Message;
END//
DELIMITER ;

--------------------------------------------- CREO EL SPB DE TipoRol ---------------------------------------------
-- Para llamar al metodo debo pasarle el id del tiporol que estoy queriendo inhabilitar y el token  --
-- CALL SPB_TipoRol(5,'ceci'); --
DELIMITER //
CREATE PROCEDURE `SPB_TipoRol`(
    IN p_Id INT, 
    IN p_UsuarioBearer TEXT(500)
)
BEGIN
    DECLARE v_IdUsuarioCarga INT;
    DECLARE v_Message VARCHAR(50);
    SET v_IdUsuarioCarga = FN_ObtenerUsuDesdeBearer(p_UsuarioBearer);

	IF v_IdUsuarioCarga IS NOT NULL THEN
		IF (SELECT COUNT(*) FROM TipoRol WHERE IdTipoRol = p_Id AND FechaBaja IS NULL) > 0 THEN
			UPDATE TipoRol 
			SET FechaBaja = NOW() 
			WHERE IdTipoRol = p_Id;
			SET v_Message = 'OK';
		ELSE 
			SET v_Message = 'El registro ya está deshabilitado o no existe';
		END IF;
	ElSE
		SET v_Message = 'Token Inválido';
	END IF;
    SELECT v_Message;
END//
DELIMITER ;
--------------------------------------------- CREO EL SPL DE TipoRol ---------------------------------------------
-- Para llamar al metodo debo pasarle el id del tipolista, endonde 1 es activo y 2 baja  --
-- CALL SPL_TipoRol(1) --
DELIMITER //
CREATE PROCEDURE `SPL_TipoRol`(
    IN TipoLista INT
)
BEGIN
    DECLARE Message VARCHAR(50);
    CREATE TEMPORARY TABLE IF NOT EXISTS TempResultados (
        IdTipoRol INT,
        Descripcion VARCHAR(50)
    );

    IF TipoLista = 1 THEN
        INSERT INTO TempResultados (IdTipoRol, Descripcion)
        SELECT IdTipoRol, Descripcion
        FROM TipoRol
        WHERE FechaBaja IS NULL;
    ELSEIF TipoLista = 2 THEN
        INSERT INTO TempResultados (IdTipoRol, Descripcion)
        SELECT IdTipoRol, Descripcion
        FROM TipoRol
        WHERE FechaBaja IS NOT NULL;
    END IF;

    IF TipoLista = 1 OR TipoLista = 2 THEN
        SELECT * FROM TempResultados;
	ELSE
		SET Message = 'Tipo de lista no válido';
        SELECT Message;
    END IF;

    -- Eliminar la tabla temporal
    DROP TEMPORARY TABLE IF EXISTS TempResultados;
END//
DELIMITER ;
--------------------------------------------- CREO EL SPL DE RolModulo ---------------------------------------------
-- Para llamar al metodo debo pasarle el id del tiporol y tipolista, donde 1 es activo y 2 es baja, para listar los roles por modulo.  --
-- CALL SPL_RolModulo(3, 5) --
DELIMITER //
CREATE PROCEDURE `SPL_RolModulo` (
    IN p_IdTipoRol INT,
    IN p_TipoLista INT
)
BEGIN
    CREATE TEMPORARY TABLE IF NOT EXISTS tmp_TablaFS_TipoRol (
        Id INT,
        IdTipoRol INT,
        TipoRol VARCHAR(50),
        IdTipoModulo INT,
        TipoModulo VARCHAR(50),
        IdTipoPermiso INT,
        TipoPermiso VARCHAR(50),
        FechaBaja VARCHAR(8)
    );
    INSERT INTO tmp_TablaFS_TipoRol (Id, IdTipoRol, TipoRol, IdTipoModulo, TipoModulo, IdTipoPermiso, TipoPermiso, FechaBaja)
    SELECT 
        a.IdRolModulo, a.IdTipoRol, b.Descripcion AS TipoRol, a.IdTipoModulo, c.Detalle AS TipoModulo, 
        a.IdTipoPermiso, d.Detalle AS TipoPermiso, DATE_FORMAT(a.FechaBaja, '%Y%m%d')
    FROM 
        RolModulo AS a 
    INNER JOIN 
        TipoRol AS b ON a.IdTipoRol = b.IdTipoRol
    INNER JOIN 
        TipoModulo AS c ON a.IdTipoModulo = c.IdTipoModulo
    INNER JOIN 
        TipoPermiso AS d ON a.IdTipoPermiso = d.IdTipoPermiso
    WHERE 
        (IFNULL(p_IdTipoRol, b.IdTipoRol) = b.IdTipoRol);

    IF p_TipoLista = 1 THEN
        DELETE FROM tmp_TablaFS_TipoRol WHERE FechaBaja IS NOT NULL;
    ELSEIF p_TipoLista = 2 THEN
        DELETE FROM tmp_TablaFS_TipoRol WHERE FechaBaja IS NULL;
	ELSE
		DELETE FROM tmp_TablaFS_TipoRol;
    END IF;

    SELECT * FROM tmp_TablaFS_TipoRol
    ORDER BY Id;
    
    DROP TEMPORARY TABLE IF EXISTS tmp_TablaFS_TipoRol;
END //

DELIMITER ;
--------------------------------------------- CREO EL SPA DE RolModulo ---------------------------------------------
-- Para llamar al metodo debo pasarle el id del tiporol que estoy queriendo inhabilitar y el token  --
-- CALL SPA_RolModulo(1, 4, 1, 'ceci') --
DELIMITER //
CREATE PROCEDURE SPA_RolModulo (
    IN v_IdTipoRol INT,
    IN v_IdTipoModulo INT,
    IN v_IdTipoPermiso INT,
    IN UsuarioBearer VARCHAR(500)
)
BEGIN
    DECLARE IdUsuarioCarga INT;
    DECLARE Message VARCHAR(50);
    DECLARE v_Count INT;
    SET IdUsuarioCarga = FN_ObtenerUsuDesdeBearer(UsuarioBearer);

	SELECT COUNT(*) INTO v_Count
	FROM TipoRol TR
	JOIN TipoModulo TM ON TR.IdTipoRol = v_IdTipoRol AND TM.IdTipoModulo = v_IdTipoModulo
	JOIN TipoPermiso TP ON TM.IdTipoModulo = v_IdTipoModulo AND TP.IdTipoPermiso = v_IdTipoPermiso;
	
	IF v_Count > 0 THEN
		IF IdUsuarioCarga IS NOT NULL THEN
			IF (SELECT COUNT(*) FROM RolModulo WHERE IdTipoRol = v_IdTipoRol AND IdTipoModulo = v_IdTipoRol 
				AND IdTipoPermiso = v_IdTipoRol) = 0 THEN
				INSERT INTO RolModulo (IdTipoRol, IdTipoModulo,IdTipoPermiso) 
				VALUES (v_IdTipoRol, v_IdTipoModulo, v_IdTipoPermiso);
				SET Message = 'OK';
			ELSE 
				SET Message = 'El valor ingresado ya existe.';
			END IF;
		ElSE
			SET Message = 'Token Inválido.';
		END IF;
	ELSE
		SET Message = 'Valores incorrectos o inválidos.';
	END IF;
    SELECT Message;
END //
DELIMITER ;
--------------------------------------------- CREO EL SPB DE RolModulo ---------------------------------------------
-- Para llamar al metodo debo pasarle el id del rolmodulo que estoy queriendo inhabilitar y el token  --
-- CALL SPB_RolModulo(1, 'ceAci') --
DELIMITER //
CREATE PROCEDURE SPB_RolModulo (
    IN p_Id INT, 
    IN p_UsuarioBearer TEXT(500)
)
BEGIN
    DECLARE v_IdUsuarioCarga INT;
    DECLARE v_Message VARCHAR(50);
    SET v_IdUsuarioCarga = FN_ObtenerUsuDesdeBearer(p_UsuarioBearer);

	IF v_IdUsuarioCarga IS NOT NULL THEN
		IF (SELECT COUNT(*) FROM RolModulo WHERE IdRolModulo = p_Id AND FechaBaja IS NULL) > 0 THEN
			UPDATE RolModulo 
			SET FechaBaja = NOW() 
			WHERE IdRolModulo = p_Id;
			SET v_Message = 'OK';
		ELSE 
			SET v_Message = 'El registro ya está deshabilitado o no existe';
		END IF;
	ElSE
		SET v_Message = 'Token Inválido';
	END IF;
    SELECT v_Message;
END //
DELIMITER ;